import processAssetVulnerabilityPairs from "./assetVulnerabilityProcessor";
import { NO_COMMON_PLATFORM_ERROR } from "./constants/error-messages";
import { InputData } from "./interfaces/input-data.interface";
import {
  INPUT_DATA_EMPTY_ENTRIES_MOCK,
  INPUT_DATA_EMPTY_MOCK,
  INPUT_DATA_MOCK,
} from "./mocks/inputData.mock";

describe("Asset Vulnerability Processor Tests", () => {
  describe("processAssetVulnerabilityPairs Tests", () => {
    it("Should return array of asset vulnerability pairs", () => {
      const inputData: InputData = INPUT_DATA_MOCK;
      const pairs = processAssetVulnerabilityPairs(inputData);
      expect(pairs).toEqual([
        {
          assetId: "asset1",
          platformName: "Platform Alpha",
          vulnerabilityId: "vuln1",
        },
        {
          assetId: "asset1",
          platformName: "Platform Alpha",
          vulnerabilityId: "vuln3",
        },
        {
          assetId: "asset2",
          platformName: "Platform Beta",
          vulnerabilityId: "vuln2",
        },
      ]);
    });

    it("Should return empty array if input is empty and run console.warn", () => {
      const spy = jest.spyOn(console, "warn").mockImplementation();

      const inputData: InputData = INPUT_DATA_EMPTY_MOCK;
      const pairs = processAssetVulnerabilityPairs(inputData);
      expect(pairs).toEqual([]);
      expect(spy).toHaveBeenCalledWith(NO_COMMON_PLATFORM_ERROR);
    });

    it("Should return array of asset vulnerability pairs if input has empty entries", () => {
      /*
            I left only one entry in the input data and removed randomly some references 
            like: platformIds, minVersion, platformName etc.
            To check the full input data, please see: src/mocks/inputData.mock.ts
        */
      const inputData: InputData = INPUT_DATA_EMPTY_ENTRIES_MOCK;
      const pairs = processAssetVulnerabilityPairs(inputData);
      expect(pairs).toEqual([
        {
          assetId: "asset1",
          platformName: "Platform Alpha",
          vulnerabilityId: "vuln3",
        },
      ]);
    });
  });
});
