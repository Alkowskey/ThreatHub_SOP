import { NO_COMMON_PLATFORM_ERROR } from "./constants/error-messages";
import { InputData } from "./interfaces/input-data.interface";
import {
  AssetVulnerabilityPair,
  PlatformRelation,
} from "./interfaces/input-relations.interface";
import { Platform } from "./interfaces/input.interface";
import InputValidators from "./validators/input.validators";
import VersionValidators from "./validators/version.validators";

function getCommonPlatform(
  assetRelations: PlatformRelation[],
  vulnerabilityRelations: PlatformRelation[],
  platforms: Platform[]
): string | undefined {
  const intersection = assetRelations.find((assetRel) =>
    vulnerabilityRelations.find(
      (vulnerabilityRel) =>
        assetRel.platformId === vulnerabilityRel.platformId &&
        VersionValidators.isValidVersion(
          assetRel.minVersion,
          assetRel.maxVersion
        ) &&
        VersionValidators.isValidVersion(
          vulnerabilityRel.minVersion,
          vulnerabilityRel.maxVersion
        ) &&
        VersionValidators.isAffectedVersion(assetRel, vulnerabilityRel)
    )
  );
  if (!intersection) return;
  return platforms.find((platform) => platform.id === intersection.platformId)
    ?.name;
}

export default function processAssetVulnerabilityPairs(
  inputData: InputData
): AssetVulnerabilityPair[] {
  const { vulnerabilities, assets, platforms } = inputData;

  const pairs: AssetVulnerabilityPair[] = assets.flatMap((asset) =>
    vulnerabilities.flatMap((vulnerability) => {
      const isValidAssetPlatformRel = InputValidators.validatePlatformRelations(
        asset.platformRelations
      );
      const isValidVulnerabilityPlatformRel =
        InputValidators.validatePlatformRelations(
          vulnerability.platformRelations
        );

      if (!isValidAssetPlatformRel || !isValidVulnerabilityPlatformRel)
        return [];

      const platformName = getCommonPlatform(
        asset.platformRelations,
        vulnerability.platformRelations,
        platforms
      );

      if (!platformName) return [];

      return {
        assetId: asset.id,
        vulnerabilityId: vulnerability.id,
        platformName,
      };
    })
  );
  if (pairs.length === 0) console.warn(NO_COMMON_PLATFORM_ERROR);
  return pairs;
}
